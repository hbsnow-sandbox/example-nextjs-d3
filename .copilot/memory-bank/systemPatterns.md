# システムパターン: Next.js + D3.js SVGグラフ表示

## システムアーキテクチャ

このプロジェクトは以下のアーキテクチャ原則に基づいて構築されています：

```
┌─────────────────────────┐
│     Next.js App         │
├─────────────────────────┤
│  ┌─────────────────┐    │
│  │  Page Component │    │
│  └─────────────────┘    │
│          │              │
│  ┌─────────────────┐    │
│  │ Graph Components│    │
│  │  ┌───────────┐  │    │
│  │  │BarGraph   │  │    │
│  │  │LineGraph  │  │    │
│  │  │MixedGraph │  │    │
│  │  └───────────┘  │    │
│  │       │         │    │
│  │  ┌───────────┐  │    │
│  │  │   D3.js   │  │    │
│  │  └───────────┘  │    │
│  └─────────────────┘    │
└─────────────────────────┘
```

1. **レイヤー構造**：

   - Pageコンポーネント層（ページレイアウト、データ統合）
   - グラフコンポーネント層（再利用可能なグラフコンポーネント）
   - D3.js計算層（スケール、軸などの計算）

2. **クライアントコンポーネント**：
   - グラフコンポーネントは`"use client"`ディレクティブを使用したクライアントコンポーネントとして実装
   - D3.jsの計算とSVG操作がクライアントサイドで実行される

## 主要な技術的決定

### 1. Reactの宣言的アプローチとD3.jsの統合

D3.jsとReactの統合において、以下の方針を採用しています：

- **計算とレンダリングの分離**：

  - D3.jsはデータの計算(スケール、座標計算など)にのみ使用
  - SVG要素の実際のレンダリングはReactコンポーネントが担当
  - D3.jsの直接的なDOM操作は使用しない

- **useMemoによる計算の最適化**：
  - D3.jsの計算負荷の高い処理は`useMemo`でメモ化
  - 依存配列を適切に設定し、必要なときだけ再計算

### 2. コンポーネント設計パターン

- **Composition Pattern**：

  - グラフコンポーネントは内部で複数のSVG要素を組み合わせる
  - Tooltip、軸、プロット領域などを組み合わせた構成

- **Props API設計**：
  - 共通のプロップス（width, height, margin）
  - 柔軟なデータ構造プロップス
  - オプショナルなカスタマイズプロップス（colors）

### 3. 状態管理

- **ローカル状態管理**：
  - 複雑なグローバルステート管理は不要
  - インタラクティブ要素（ツールチップなど）にはuseStateを使用
  - ホバー状態などのUI状態はコンポーネント内で管理

## コンポーネント関係

```
┌─────────────────┐
│   グラフ基盤     │
│  ┌───────────┐  │
│  │ constants │  │ ← 共通定数（色など）
│  └───────────┘  │
│  ┌───────────┐  │
│  │ tooltip   │  │ ← 共通ツールチップコンポーネント
│  └───────────┘  │
└─────────────────┘
        ▲
        │
┌───────┴───────┐
│               │
▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  BarGraph   │ │  LineGraph  │ │ MixedGraph  │
└─────────────┘ └─────────────┘ └─────────────┘
```

## 実装パターン

### データフロー

1. **プロップスを通じたデータ入力**：

   - 構造化されたデータオブジェクトをプロップスとして受け取る
   - TypeScriptによる型定義で正しいデータ構造を保証

2. **D3.jsによるデータ計算**：

   - スケールの計算 (`d3.scaleLinear`, `d3.scaleBand` など)
   - 軸の目盛り値計算 (`scale.ticks()`)
   - ドメインとレンジの設定

3. **Reactによるレンダリング**：
   - 計算された値に基づいてSVG要素をレンダリング
   - 必要に応じて配列の`map`メソッドを使用して要素を生成

### インタラクション処理

LineGraphコンポーネントでは以下のインタラクションパターンを採用：

1. **透明なオーバーレイ要素**：

   - 各データポイントの周囲に透明な`rect`要素を配置
   - マウスイベントの検出エリアとして機能

2. **イベントハンドリング**：

   - `onMouseMove`、`onMouseLeave`イベントをハンドリング
   - イベント情報からマウス座標を取得

3. **状態更新**：

   - マウスイベントに基づいてuseStateで管理された状態を更新
   - ツールチップの位置と表示内容を制御

4. **ビジュアルフィードバック**：
   - ガイドラインの表示
   - ツールチップの表示・位置更新
